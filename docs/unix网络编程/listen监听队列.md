## listen监听队列

- int listen(int listen_fd, int backlog)

- 对于一个调用listen的进行监听的套接字，操作系统会给这个套接字维护两个队列

  1. 未完成链接队列

     当客户端发送连接时的第一个syn包给服务器时，服务器就会在未完成对可中创建一个个这个syn包对应的意向，这个时候链接尚未完成，这个连接的状态从listen的状态变成syn_revd状态，同时给客户端返回ack包进行第二次握手，然后等待第三次握手

  2. 已完成链接队列

     当第三次握手完成，状态变成established，每个完成链接的队列都从未完成队列转移到已完成连接队列，FIFO队列

  3. backlog即规定了已完成队列和未完成队列的项目之和的最大值。如果队列和等于该值，即队列已满，如果服务器再接受到syn请求建立连接，那么服务器直接忽略该包。后来为了防止syn攻击，backlog修改为已完成连接队列的最大值

  4. RTT：分为客户端和服务端的RTT，客户端为第一次和第二次握手的时间(一去一回)，服务端为第二次和第三次握手的时间(同样是一去一回)。网络平均RTT为187ms.

### SYN攻击

- 如果恶意客户不发送第三次握手，这个链接就无法建立，那么syn_rcvd这一项会停留在为未完成队列75s，黑客可能利用这一特点不停地往服务器发送syn包而不回送第三次无握手，那么就会导致监听队列满，那就就会导致服务器无法提供正常的服务，即DOS

### connect

connect在收到服务端的syn/ack包后就返回，即第二次握手完成

### accept

从已完成连接队列的队首取出一项返回(返回一个conn_fd套接字)，如果已完成链接队列为空，那么accept会阻塞。如果在accept取出一个连接之前，这个已建立链接的客户端发送了数据，这个数据会放到接收缓冲区